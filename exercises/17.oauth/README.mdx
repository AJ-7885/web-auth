# OAuth

- [An Introduction to OAuth 2](https://www.digitalocean.com/community/tutorials/an-introduction-to-oauth-2)

![A flow diagram showing a user, server, provider, and connection in a database](https://github-production-user-asset-6210df.s3.amazonaws.com/1500684/269059627-5265f0b8-c364-453b-806e-66802e6283cd.png)

Here's how the flow goes:

- The user clicks "login with provider"
- The server redirects the user to the provider (and sets a cookie to keep track
  of the user so we remember them when they come back).
- The user authenticates with the provider
- The provider redirects the user which triggers a request to the server with a
  code and some information to associate the user with their cookie.
- The server exchanges the code for an access token and uses that to get the
  user's profile.
- The server gets or creates a connection in the database for the user if the
  user already exists and redirects them home
- Otherwise, the server redirects to onboarding with a value in the
  `verifySession` that verifies the user owns the email address with which they
  authenticated on the provider.

## remix-auth

```tsx file=app/utils/connections.server.ts
import { createCookieSessionStorage } from '@remix-run/node'

export const connectionSessionStorage = createCookieSessionStorage({
	cookie: {
		name: 'en_connection',
		sameSite: 'lax',
		path: '/',
		httpOnly: true,
		maxAge: 60 * 10, // 10 minutes
		secrets: process.env.SESSION_SECRET.split(','),
		secure: process.env.NODE_ENV === 'production',
	},
})
```

```tsx file=app/utils/auth.server.ts
type ProviderUser = {
	// ... user data stored in the session
}
export const authenticator = new Authenticator<ProviderUser>(
	connectionSessionStorage,
)

authenticator.use(
	new GitHubStrategy(
		{
			clientID: process.env.GITHUB_CLIENT_ID,
			clientSecret: process.env.GITHUB_CLIENT_SECRET,
			callbackURL: '/auth/github/callback',
		},
		async ({ profile }) => {
			// convert the user's profile into what the user object should be
			return {
				// ... user data stored in the session
			}
		},
	),
	// name the strategy:
	'github',
)
```

```tsx file=app/routes/_auth+/auth.github.ts
return await authenticator.authenticate('github', request)
// throws a redirect to GitHub + sets a cookie with some state
```

```tsx file=app/routes/_auth+/auth.github.callback.ts
// GitHub redirects with the code and the state value
const data = await authenticator.authenticate('github', request, {
	throwOnError: true,
})
```

- [ðŸ“œ remix-auth](https://github.com/sergiodxa/remix-auth)
